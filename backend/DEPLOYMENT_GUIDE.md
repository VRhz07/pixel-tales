# Pixel Tales Backend Deployment Guide - Render.com

## Prerequisites
- GitHub account
- Render.com account (free tier)
- Your backend code pushed to GitHub

## Step-by-Step Deployment

### 1. Prepare Your GitHub Repository

```bash
# Make sure all changes are committed
cd backend
git add .
git commit -m "Prepare backend for Render.com deployment"
git push origin main
```

### 2. Create a Render.com Account
1. Go to https://render.com
2. Sign up using your GitHub account
3. Authorize Render to access your repositories

### 3. Deploy Using render.yaml (Recommended)

#### Option A: Automatic Deployment
1. Click "New +" in Render dashboard
2. Select "Blueprint"
3. Connect your GitHub repository
4. Render will detect `render.yaml` automatically
5. Click "Apply"

#### Option B: Manual Web Service Creation
1. Click "New +" → "Web Service"
2. Connect your GitHub repository
3. Configure the following:
   - **Name**: `pixeltales-backend`
   - **Region**: Oregon (Free)
   - **Branch**: `main`
   - **Root Directory**: `backend`
   - **Environment**: Python 3
   - **Build Command**: `./build.sh`
   - **Start Command**: `daphne -b 0.0.0.0 -p $PORT storybookapi.asgi:application`
   - **Plan**: Free

### 4. Configure Environment Variables

In Render dashboard, go to your service → Environment:

**Required Variables:**
```
DEBUG=False
SECRET_KEY=<auto-generated by Render>
ALLOWED_HOSTS=your-app-name.onrender.com
GOOGLE_AI_API_KEY=<your-gemini-api-key>
SENDGRID_API_KEY=<your-sendgrid-key>
FROM_EMAIL=noreply@yourdomain.com
DATABASE_URL=sqlite:///data/db.sqlite3
JWT_ACCESS_TOKEN_LIFETIME_DAYS=30
JWT_REFRESH_TOKEN_LIFETIME_DAYS=365
RENDER=True
```

**Optional Variables:**
```
EMAIL_VERIFICATION_EXPIRY_MINUTES=15
```

### 5. Add Persistent Disk (Important for SQLite!)

1. In your service settings, scroll to "Disks"
2. Click "Add Disk"
3. Configure:
   - **Name**: `pixeltales-data`
   - **Mount Path**: `/opt/render/project/src/data`
   - **Size**: 1 GB (Free tier)
4. Save changes

### 6. Make build.sh Executable

If deployment fails with permission error:
```bash
# In your local repository
cd backend
chmod +x build.sh
git add build.sh
git commit -m "Make build.sh executable"
git push origin main
```

### 7. Deploy!

1. Render will automatically deploy on push
2. Watch the build logs in Render dashboard
3. First deployment takes 5-10 minutes
4. Your API will be available at: `https://your-app-name.onrender.com`

### 8. Create Admin User

After successful deployment:

```bash
# In Render dashboard, open Shell
python manage.py createsuperuser
```

Or use the Django admin panel:
- Visit: `https://your-app-name.onrender.com/admin`
- Create account manually

### 9. Test Your API

```bash
# Health check
curl https://your-app-name.onrender.com/api/

# Test authentication
curl https://your-app-name.onrender.com/api/auth/register/ \
  -X POST \
  -H "Content-Type: application/json" \
  -d '{"username":"testuser","email":"test@example.com","password":"testpass123"}'
```

## Update Frontend Configuration

### Update frontend/.env:
```env
# Production API URL
VITE_API_BASE_URL=https://your-app-name.onrender.com/api

# Keep other settings the same
VITE_GEMINI_API_KEY=your-key
VITE_OCR_SPACE_API_KEY=your-key
```

## Important Notes

### Free Tier Limitations:
- ⚠️ **Spins down after 15 minutes of inactivity** - First request takes 30-60 seconds
- ✅ 750 hours/month free compute
- ✅ 1 GB persistent disk included
- ✅ Automatic SSL certificate
- ✅ Unlimited bandwidth

### SQLite in Production:
- ✅ Perfect for MVP and testing
- ✅ Handles 100k+ reads/sec
- ⚠️ Single writer (not ideal for high concurrent writes)
- ✅ Easy backup (just download the disk)

### When to Upgrade:
- You exceed 10,000+ active users
- You need multiple concurrent writers
- You want to use Render's PostgreSQL features
- Free tier spin-down is affecting UX

## Troubleshooting

### Build Fails
```bash
# Check build logs in Render dashboard
# Common issues:
# 1. Missing dependencies → Update requirements.txt
# 2. Migration errors → Check database connection
# 3. Permission denied → Make build.sh executable
```

### Database Not Persisting
```bash
# Verify disk is mounted:
# In Render Shell:
ls -la /opt/render/project/src/data
# Should show db.sqlite3 after first run
```

### CORS Errors
```bash
# Add your frontend URL to ALLOWED_HOSTS and CORS_ALLOWED_ORIGINS
# In Environment Variables:
ALLOWED_HOSTS=your-backend.onrender.com,localhost
```

### Static Files Not Loading
```bash
# Run in Render Shell:
python manage.py collectstatic --no-input
```

## Backup Your Database

```bash
# Download SQLite database from Render dashboard:
# Services → Your Service → Shell
# Run: cat /opt/render/project/src/data/db.sqlite3 > ~/backup.db

# Or use Render's disk backup feature (paid plans)
```

## Next Steps

1. ✅ Deploy backend to Render
2. ✅ Update frontend API URL
3. ✅ Test all API endpoints
4. ✅ Build APK with production API URL
5. ✅ Test on mobile devices

## Useful Commands

```bash
# View logs
# In Render dashboard → Logs

# Run migrations
# In Render Shell:
python manage.py migrate

# Create superuser
python manage.py createsuperuser

# Check database
python manage.py dbshell

# Restart service
# In Render dashboard → Manual Deploy → Clear build cache & deploy
```

## Support

- Render Docs: https://render.com/docs
- Django Deployment: https://docs.djangoproject.com/en/4.2/howto/deployment/
- Issues: Check Render dashboard logs

---

**Deployment Time**: ~10 minutes
**Cost**: $0 (Free tier)
**SSL**: Automatic
**Domain**: `your-app-name.onrender.com`
