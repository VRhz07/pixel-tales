# Testing Instructions: Verify imagePrompt Flow

## Objective
Verify that the `imagePrompt` field is properly generated by Gemini and sent to Replicate.

---

## Test Setup

### Prerequisites
1. âœ… Backend server running (`python manage.py runserver`)
2. âœ… Frontend server running (`npm run dev`)
3. âœ… Browser DevTools open (F12) â†’ Console tab
4. âœ… Backend console/terminal visible

---

## Test Steps

### Step 1: Clear All Consoles

**Frontend (Browser Console):**
- Press `Ctrl+L` or click the ğŸš« icon to clear

**Backend (Terminal):**
- You should see logs as requests come in

### Step 2: Generate a Simple Test Story

1. Navigate to the app
2. Click "Create AI Story"
3. Enter a simple story idea: **"A brave little fox learning to swim"**
4. Select:
   - Art Style: **Cartoon**
   - Genre: **Adventure**
   - Story Length: **5 pages** (fastest)
   - Language: **English**
5. Click **"Generate My Story"**

### Step 3: Monitor Frontend Console

Watch for these key log sections:

#### Section A: Gemini Response Validation
```
========================================
ğŸ” GEMINI RESPONSE STRUCTURE VALIDATION
========================================
ğŸ” Full storyData keys: [title, description, characterDescription, colorScheme, pages]
ğŸ” storyData.pages exists: true
ğŸ” storyData.pages is array: true
ğŸ” Story has 5 pages, X have imagePrompt  â† CHECK THIS NUMBER

ğŸ” Page 1 details:
   Keys: [pageNumber, narrativePurpose, mood, illustrationDescription, imagePrompt, text]
   Has imagePrompt: true  â† SHOULD BE TRUE
   imagePrompt (first 100 chars): Cartoon illustration of a small fox with bright orange...
   
ğŸ” Page 2 details:
   ...
```

**âœ… Expected:** All 5 pages should have `imagePrompt: true`
**âŒ Problem:** If any page shows `imagePrompt: false` or the field is missing from Keys

#### Section B: Image Generation Start
```
========================================
ğŸ” STARTING PAGE ILLUSTRATIONS GENERATION
========================================
ğŸ” Pages to generate images for: 5
ğŸ” First page structure: [pageNumber, narrativePurpose, mood, illustrationDescription, imagePrompt, text]
ğŸ” First page has imagePrompt: true  â† SHOULD BE TRUE
ğŸ” First page imagePrompt preview: Cartoon illustration of...

ğŸ” ALL PAGES STRUCTURE:
   Page 1: keys = [...], hasImagePrompt = true
   Page 2: keys = [...], hasImagePrompt = true
   Page 3: keys = [...], hasImagePrompt = true
   Page 4: keys = [...], hasImagePrompt = true
   Page 5: keys = [...], hasImagePrompt = true
```

**âœ… Expected:** All pages show `hasImagePrompt = true`
**âŒ Problem:** If any page shows `hasImagePrompt = false`

#### Section C: Per-Page Generation
```
ğŸ¨ generateStoryIllustrationsFromPrompts called with:
   pageCount: 5
   pagesStructure: [
     {index: 0, hasImagePrompt: true, imagePromptPreview: "Cartoon..."}
     {index: 1, hasImagePrompt: true, imagePromptPreview: "Cartoon..."}
     ...
   ]

ğŸ–¼ï¸ Page 1/5: Starting image generation...
ğŸ¨ Generating image with Replicate (FLUX model)...
âœ… Image generated via Replicate backend proxy
ğŸ”— Image URL: https://replicate.delivery/...
```

**âœ… Expected:** Each page generates successfully
**âŒ Problem:** If you see `âŒ Page X missing imagePrompt field!`

### Step 4: Monitor Backend Console

Watch for these backend logs:

```
ğŸ¨ Generating image with Replicate: black-forest-labs/flux-schnell
ğŸ“ Input params: {'prompt': 'Cartoon illustration of...', 'aspect_ratio': '1:1', 'num_outputs': 1, 'seed': 123456}
âœ… Image generated: https://replicate.delivery/...
```

**Check the `prompt` value in input_params:**
- âœ… Should be a long string (200+ characters)
- âœ… Should contain character description
- âœ… Should contain scene details
- âŒ Should NOT be empty or very short (< 50 chars)

---

## Expected Results

### âœ… Success Scenario

**Frontend Console:**
- Gemini returns 5 pages, all with `imagePrompt: true`
- All pages have imagePrompt field in their keys
- imagePrompt previews show detailed descriptions
- All 5 images generate successfully

**Backend Console:**
- 5 separate Replicate API calls
- Each with a detailed prompt (200+ chars)
- Each returns a valid image URL

**Result:**
- Story created with 5 illustrated pages
- All images load correctly

### âŒ Failure Scenario 1: Missing imagePrompt Field

**Frontend Console:**
```
ğŸ” Story has 5 pages, 0 have imagePrompt  â† PROBLEM!
âŒ PROBLEM: NO PAGES HAVE imagePrompt FIELD!
ğŸ” This means Gemini did not generate the imagePrompt field.

Page 1 details:
   Keys: [pageNumber, text, mood, illustrationDescription]  â† imagePrompt MISSING!
   Has imagePrompt: false
```

**What This Means:**
- Gemini is not generating the `imagePrompt` field
- It might be generating `illustrationDescription` instead
- The prompt sent to Gemini needs adjustment

**Next Steps:**
1. Check `geminiService.ts` or `geminiProxyService.ts` 
2. Verify the prompt explicitly requires `imagePrompt` field
3. Check if Gemini is interpreting the JSON structure correctly

### âŒ Failure Scenario 2: Empty imagePrompt Values

**Frontend Console:**
```
Page 1 details:
   Has imagePrompt: true
   imagePrompt (first 100 chars): undefined...  â† PROBLEM!
```

**What This Means:**
- Field exists but is empty/undefined
- Gemini created the field but didn't populate it

### âŒ Failure Scenario 3: Short/Incomplete Prompts

**Backend Console:**
```
ğŸ“ Input params: {'prompt': 'A fox', ...}  â† TOO SHORT!
```

**What This Means:**
- imagePrompt exists but lacks detail
- Character descriptions not included
- Prompt truncated or simplified

---

## Diagnostic Questions to Answer

After running the test, answer these:

1. **How many pages have imagePrompt?**
   - Look for: `ğŸ” Story has 5 pages, X have imagePrompt`
   - Expected: X = 5
   - Actual: ___

2. **What keys does page 1 have?**
   - Look for: `Keys: [...]`
   - Expected: `[pageNumber, narrativePurpose, mood, illustrationDescription, imagePrompt, text]`
   - Actual: ___

3. **What does the first imagePrompt preview show?**
   - Look for: `imagePrompt (first 100 chars): ...`
   - Expected: Long detailed description starting with art style
   - Actual: ___

4. **What does the backend receive?**
   - Look for: `ğŸ“ Input params: {'prompt': '...'}`
   - Expected: Long string with character details
   - Actual: ___

5. **Any error messages?**
   - Look for: `âŒ` symbols in console
   - List any errors: ___

---

## Sharing Results

If you encounter issues, please provide:

1. **Screenshot or copy-paste of frontend console** showing:
   - The "GEMINI RESPONSE STRUCTURE VALIDATION" section
   - The "STARTING PAGE ILLUSTRATIONS GENERATION" section
   - Any red error messages

2. **Screenshot or copy-paste of backend console** showing:
   - The "Generating image with Replicate" lines
   - The input_params with the prompt

3. **Specific observations:**
   - How many pages had imagePrompt?
   - What did the prompt look like?
   - Did images generate at all?

---

## Quick Reference: Where to Look

| What to Check | Where to Find It |
|---------------|------------------|
| Pages have imagePrompt field? | Frontend console â†’ "GEMINI RESPONSE STRUCTURE VALIDATION" |
| imagePrompt content preview? | Frontend console â†’ "Page X details" â†’ "imagePrompt (first 100 chars)" |
| What prompt was sent? | Backend console â†’ "Input params" â†’ "prompt" value |
| Images generated? | Frontend console â†’ "âœ… Image generated via Replicate" |
| Error messages? | Both consoles â†’ Look for "âŒ" symbols |

---

## Summary

This test will definitively show:
1. âœ… Whether Gemini is generating the imagePrompt field
2. âœ… Whether the imagePrompt contains detailed character descriptions
3. âœ… Whether the full prompt reaches Replicate
4. âœ… Where in the pipeline any data is being lost

Run this test and share the results, and we'll know exactly what needs to be fixed!
